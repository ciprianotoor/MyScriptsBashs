#!/bin/bash
# backup-timeshift-proxmox.sh
#
# Script para crear un backup con Timeshift en Proxmox VE
# Ejecuta Timeshift con sudo, mantiene últimos 7 snapshots diarios
# y permite eliminar snapshots manualmente

MAX_SNAPSHOTS=7
DATE=$(date +'%Y-%m-%d %H:%M:%S')

echo "==== Backup Timeshift Proxmox iniciado: $DATE ===="

# Crear snapshot usando Timeshift (se monta el dispositivo interno automáticamente)
sudo timeshift --create --comments "Backup Proxmox $DATE" --tags D

if [ $? -eq 0 ]; then
    echo "Backup creado exitosamente ✔"
else
    echo "ERROR: Fallo al crear el backup con Timeshift"
    exit 1
fi

# Limpiar snapshots antiguos (mantener solo los últimos MAX_SNAPSHOTS diarios)
echo "Limpiando snapshots antiguos, manteniendo solo los últimos $MAX_SNAPSHOTS..."
SNAPSHOTS=$(sudo timeshift --list | grep "D" | awk '{print $3}' | sort -r)

COUNT=0
for SNAP in $SNAPSHOTS; do
    COUNT=$((COUNT+1))
    if [ $COUNT -gt $MAX_SNAPSHOTS ]; then
        echo "Eliminando snapshot: $SNAP"
        sudo timeshift --delete --snapshot "$SNAP"
    fi
done

# Listar todos los snapshots existentes
echo
echo "==== Snapshots actuales ===="
sudo timeshift --list

# Preguntar si el usuario quiere eliminar algún snapshot manualmente
echo
read -p "¿Desea eliminar algún snapshot manualmente? (s/n): " RESPUESTA
if [[ "$RESPUESTA" =~ ^[Ss]$ ]]; then
    read -p "Ingrese el nombre exacto del snapshot a eliminar: " SNAP_ELIMINAR
    if [ -n "$SNAP_ELIMINAR" ]; then
        echo "Eliminando snapshot $SNAP_ELIMINAR..."
        sudo timeshift --delete --snapshot "$SNAP_ELIMINAR"
        echo "Snapshot eliminado ✔"
    else
        echo "No se ingresó ningún snapshot. Cancelando eliminación."
    fi
fi

echo "==== Backup finalizado ===="
